# 哈?操作系统 临时笔记-2

1. 物理内存根据 NUMA 架构分节点
2. 每个节点里面再分区域
3. 每个区域里面再分页
4. 物理页面通过伙伴系统进行分配
5. 分配的物理页面要变成虚拟地址让上层可以访问，kswapd 可以根据物理页面的使用情况对页面进行换入换出
6. 对于内存的分配需求，可能来自内核态，也可能来自用户态
7. 对于内核态`kmalloc`在分配大内存的时候，以及 vmalloc 分配不连续物理页的时候，直接使用伙伴系统，分配后转换为虚拟地址，访问的时候需要通过内核页表进行映射
8. 对于`kmem_cache`以及`kmalloc`分配小内存，则使用`slub`分配器，将伙伴系统分配出来的大块内存切成一小块一小块进行分配`kmem_cache`和`kmalloc`的部分不会被换出，因为用这两个函数分配的内存多用于保持内核关键的数据结构
9. 内核态中`vmalloc`分配的部分会被换出,因而当访问的时候，发现不在，就会调用 缺页异常
10. 对于用户态的内存分配，或者直接调用`mmap`系统调用分配，或者调用`malloc`.调用`malloc`的时候，如果分配小的内存，就用`sys_brk`系统调用；如果分配大的内存，还是用`sys_mmap`系统调用正常情况下，用户态的内存都是可以换出的，因而一旦发现内存中不存在，就会调用 缺页异常

# 构建可用于生产的智能体系统：Shopify Sidekick 的经验教训
======================================================

原文地址: <https://shopify.engineering/building-production-ready-agentic-systems>

我们如何演进 AI 助手架构，并为真实世界部署构建了强健的评估框架

![](https://cdn.shopify.com/s/files/1/0779/4361/articles/image_1_22dc70db-d4c8-4175-8c9b-3638274a2e6c.png?v=1756239806&originalWidth=1848&originalHeight=782)

Shopify 工程团队

_本文基于 Andrew McNamara、Ben Lafferty 和 Michael Garner 在 ICML 2025 上的演讲：[构建可用于生产的智能体系统：架构、基于 LLM的评估与 GRPO 训练](https://icml.cc/virtual/2025/46781)。_

在 Shopify，我们一直在打造 [Sidekick](https://www.shopify.com/magic)，一个 AI 驱动的助手，帮助商家通过自然语言交互管理店铺。从分析客户分群到填写产品表单、导航复杂的后台界面，Sidekick 已从一个简单的工具调用系统演变为复杂的智能体平台。在这个过程中，我们在架构设计、评估方法和训练技术方面积累了宝贵经验，愿与更广泛的 AI 工程社区分享。

**Sidekick 架构的演进**
-----------------------

Sidekick 的核心是 Anthropic 所称的“智能体循环”——一个持续的循环：人类提供输入，LLM 处理输入并决定行动，行动在环境中执行，收集反馈，循环直到任务完成。

![](https://cdn.shopify.com/s/files/1/0779/4361/files/agenticloop_ecdd37d0-0dd2-4171-ba5a-0cda8a79c003.png?v=1755211658)

实际应用中，Sidekick 能自动查询客户数据、应用合适的筛选条件并展示结果，比如处理“哪些客户来自多伦多？”的请求。又如商家请求撰写 SEO 描述时，Sidekick 能识别相关产品、理解上下文，并直接在产品表单中填入优化内容。

![](https://cdn.shopify.com/s/files/1/0779/4361/files/segmentation.png?v=1755211701)

### **工具复杂性问题**

随着 Sidekick 能力扩展，我们很快遇到了许多智能体系统团队都会遇到的扩展挑战。我们的工具库从几个明确定义的函数，增长到数十个专业化能力：

![](https://cdn.shopify.com/s/files/1/0779/4361/files/toolcomplexity.png?v=1755211760)

* **0-20 个工具**：边界清晰，易于调试，行为简单
* **20-50 个工具**：边界变得模糊，工具组合开始导致意外结果
* **50+ 个工具**：同一任务有多种实现方式，系统变得难以理解

这导致了我们称之为“千条指令之死”的问题——系统提示词变成了大量特殊情况、冲突指导和边界处理的集合，拖慢系统速度，维护变得几乎不可能。

![](https://cdn.shopify.com/s/files/1/0779/4361/files/deathbyathousandinstructions.png?v=1755211795)

### **即时指令：扩展的解决方案**

我们的突破在于实施了即时（JIT）指令。不再把所有指导塞进系统提示词，而是在需要时与工具数据一起返回相关指令。我们的目标是为每个场景为 LLM 构建完美上下文，不多一词，不少一词。

**实际工作方式**

下方为提供给 LLM 的指令：

上方为 LLM 基于指令生成的响应：

![](https://cdn.shopify.com/s/files/1/0779/4361/files/prompt.png?v=1755212586)

这种方式带来三大好处：

1. **本地化指导**：指令仅在相关时出现，核心系统提示词专注于智能体基本行为
2. **缓存效率**：可动态调整指令而不破坏 LLM 提示词缓存
3. **模块化**：可根据测试标志、模型版本或页面上下文提供不同指令

效果立竿见影——系统更易维护，性能全面提升。

**构建强健的 LLM 评估系统**
----------------------------

部署智能体系统最大挑战之一是评估。传统软件测试方法难以应对 LLM 输出的概率性和多步智能体行为的复杂性。

![](https://cdn.shopify.com/s/files/1/0779/4361/files/Vibetest.png?v=1755213228)

如今很多人用“感觉测试”评估 LLM 系统，认为足够了；其实远远不够。感觉测试，或“Vibe LLM Judge”那种“0-10 打分”，是不够的。评估必须有原则、统计严谨，否则上线时只是虚假的安全感。

![](https://cdn.shopify.com/s/files/1/0779/4361/files/sidekickerror.png?v=1755213874)

### **真实分布集优于黄金数据集**

我们不再使用精心策划的“黄金”数据集，而是转向反映实际生产分布的真实分布集（GTX）。不再试图预判所有可能交互（规范文档常见做法），而是采样真实商家对话，并基于实际观察制定评估标准。

![](https://cdn.shopify.com/s/files/1/0779/4361/files/groundtruthset.png?v=1755213948)

流程包括：

1. **人工评估**：至少三位产品专家对多项标准标注对话
2. **统计验证**：用 Cohen's Kappa、Kendall Tau、Pearson 相关性衡量标注者一致性
3. **基准测试**：将人工一致性作为 LLM 评判理论最大值

![](https://cdn.shopify.com/s/files/1/0779/4361/files/evaluation.png?v=1755214576)

### **LLM 评判与人工一致性**

我们为 Sidekick 的不同性能方面开发了专用 LLM 评判器，关键在于与人工评判校准。通过多轮提示词迭代，评判器从几乎随机（Cohen's Kappa 0.02）提升到接近人工水平（0.61 vs. 人类基线 0.69）。当我们的 LLM Judge 与人工高度相关，并且在 GTX 中随机替换 Judge 为人工时难以分辨，就说明评判器值得信赖。

![](https://cdn.shopify.com/s/files/1/0779/4361/files/LLMjudge.png?v=1755214642)

### **用户模拟实现全面测试**

为在生产前测试候选变更，我们构建了 LLM 驱动的商家模拟器，捕捉真实对话的“本质”或目标，并在新系统候选上重放。这让我们能模拟多种系统候选，选出表现最佳者。

![](https://cdn.shopify.com/s/files/1/0779/4361/files/robot.png?v=1755216341)

完整评估流程如下：

![](https://cdn.shopify.com/s/files/1/0779/4361/files/Evaluationpipeline.png?v=1755216366)

这种方法对发现回归和验证改进至关重要。

**GRPO 训练与奖励规避**
-----------------------

模型微调时，我们采用了分组相对策略优化（GRPO），一种以 LLM 评判为奖励信号的强化学习方法。我们开发了 N 阶段门控奖励系统，将程序化验证（语法检查、结构校验）与 LLM 语义评估结合。

![](https://cdn.shopify.com/s/files/1/0779/4361/files/GRPO.png?v=1755216699)

### **奖励规避的现实**

尽管评估设计谨慎，训练过程中仍出现了严重奖励规避。模型用创造性方式“钻空子”：

* **选择性放弃**：遇到难题时直接解释无法帮助
* **标签滥用**：用客户标签代替正确字段映射
* **结构违规**：虚构 ID 或使用错误枚举值

例如，要求“分群状态为 enabled 的客户”，模型学会了用 `customer_tags CONTAINS 'enabled'`，而不是正确的 `customer_account_status = 'ENABLED'`。

### **迭代改进**

解决奖励规避需同时更新语法验证器和 LLM 评判器以识别这些失败模式。修正后：

* 语法验证准确率从约 93% 提升到约 99%
* LLM 评判相关性从 0.66 提升到平均 0.75
* 最重要的是，端到端对话质量与有监督微调基线持平

**生产智能体系统的关键经验**
----------------------------

基于 Sidekick 的构建与部署经验，我们有如下建议：

### **架构原则**

* **保持简单**：没有明确边界不要随意加工具，智能体能力质量远重于数量
* **从模块化开始**：一开始就用 JIT 指令等模式，保证系统可扩展性
* **早期避免多智能体架构**：单智能体系统能处理的复杂度远超预期

### **评估基础设施**

* **构建多个 LLM 评判器**：智能体性能不同方面需专用评估方法
* **与人工评判对齐**：与人工评估的统计相关性是自动评估可信的基础
* **预期奖励规避**：模型总会“钻空子”，需提前设计检测机制

### **训练与部署**

* **程序化+语义验证**：规则校验与 LLM 评估结合，奖励信号更健壮
* **用户模拟**：投入真实用户模拟器，生产前全面测试
* **评判器迭代改进**：不断发现新失败模式，持续优化评判器

**展望未来**
------------

我们将持续演进 Sidekick 的架构与评估系统。未来工作包括将推理轨迹纳入训练流程，在训练中用模拟器和生产评判器，以及探索更高效的训练方法。

生产智能体系统领域仍很年轻，但 Shopify 总结的模式——模块化架构、强健评估框架、奖励规避防范——为打造可靠 AI 助手奠定了基础，让商家真正受益。

构建可用于生产的智能体系统，远不止把 LLM 接工具那么简单。它需要深思熟虑的架构决策、严谨的评估方法，以及对系统可能失败方式的持续警惕。但如果做对了，AI 就能真正有意义地增强人类能力。
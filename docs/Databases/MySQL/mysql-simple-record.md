# 日常Mysql的小随记

## **问题表现**

---

### **用了索引,但是查询速度还是慢**

#### 开始定位-1

在数据库审验表结构时,发现公司有的表使用的是utf8,有的使用的是utf8md4.

使用关联查询时,如果会涉及到字符串的转换,导致使用相关函数,MySQL是会在有索引的字段上用函数操作,导致索引失效.

因为在使用索引的时候,其实是利用了[B+树](https://zh.wikipedia.org/wiki/B%2B%E6%A0%91)这种结构,能够快速定位得益于来源是同一兄弟节点的的有序性,对有索引的字段值做函数操作会破坏索引值的有序性,从而放弃使用树搜索(没有放弃使用索引).

#### 总结-1

1. 尽量统一字符编码
2. 一些涉及到函数使用,比如数据类型转换(字符串到int),字符编码的转换(utf8到utf8mb4),以及使用日期函数来查找区间,都要慎重

---

### **Innodb的表中自增id出现不连续**

#### 开始定位-2

在事务回滚或者出现异常和多次批量插入数据操作均会出现.

出现问题的表的引擎都是InnoDB.

在 MyISAM 引擎里面，自增值是被写在数据文件上的。而在 InnoDB 中，自增值是被记录在内存的。

Innodb的表中自增id会出现不连续,还有在批量插入数据的时候,语句执行过程中，第一次申请自增 id，会分配 1 个；1 个用完以后，这个语句第二次申请自增 id，会分配 2 个；2 个用完以后，还是这个语句，第三次申请自增 id，会分配 4 个；依此类推，同一个语句去申请自增 id，每次申请到的自增 id 个数都是上一次的两倍。那么在插入数据没有使用完分配的自增id,那么下一次申请时的自增id就会出现不连续

### 总结-2

1. 尽量保证自增id的连续性,因为自增id的连续可以避免页分裂,使索引更紧凑
